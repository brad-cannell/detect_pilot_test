---
title: "Preprocess merged data for analysis"
date: "Created: 2016-10-14 <br> Updated: `r Sys.Date()`"
output: 
  html_notebook:
    css: custom-css.css
---

# Overview

In this file we take the merged MedStar DETECT and APS investigations data that we previously merged together and do a little bit of preprocessing for later analysis.

We start with the following data:

1. **merged.feather** - MedStar DETECT screenings that were matched to APS investigations on name and date of birth. Data cleaned in data_merge_medstar_aps.Rmd

2. **

# Table of contents

1. [Preprocess for analysis](#preprocess)     
    1. Create an **any_valid** variable            
    2. Recode DETECT responses to NA    
    
2. [Create a deidentified version of the merged data](#deidentify)    
3. [Save preprocessed data](#save)      
    1. merged_screening_recode.feather    
    2. merged_screening_recode_deidentified.feather     
    3. merged_screening_recode_deidentified.csv    

```{r setup, include=FALSE}
knitr::opts_chunk$set(comment = NA)
Sys.setenv(TZ = "US/Central")
```

```{r load_packages, message=FALSE}
library(tidyverse)
library(bfuncs)
```

```{r}
merged <- feather::read_feather("/Users/bradcannell/Desktop/merged.feather")
about_data(merged) # 67 observations and 57 variables in the data 
```










-------------------------------------------------------------------------------

# Preprocess for analysis {#preprocess}

-------------------------------------------------------------------------------

Because it is possible for there to be more than one allegation associated with each APS investigation, some investigations have more than one row in the data. It is also possible to have more than one instance of the DETECT screening tool used (response number) per APS investigation (case number).

We want a single outcome per investigation/response combination (pair) in order to create a confusion matrix for each screening item.

To do that, we will create a new variable called "any_valid" that is equal to 1 if the disposition of _any_ allegation was valid, and 0 if the disposition of _all_ allegations were invalid. 


## 1. Create any_valid

Create new outcome variable (any_valid) that is equal to 1 when any type of abuse is validated for a given response pair (DETECT screen / APS investigation match). For response pairs with multiple dispositions:   
  + If even one disposition is valid, then any valid equals 1   
  + If all dispositions are invalid, then any valid equals 0   
  + If all dispositions are other, then any valid equals NA
  + If one disposition is other, and the rest are invalid, then any valid equals NA
  
```{r}
merged <- merged %>% 
  group_by(pair) %>% 
  mutate(
    any_valid = case_when(
      any(disposition == "Valid")   ~ 1L,
      all(disposition == "Invalid") ~ 0L,
      TRUE                          ~ NA_integer_
    ) 
  ) %>% 
  ungroup()

about_data(merged) # 67 observations and 58 variables
```


## 2. Recode DETECT responses to NA

We will recode "Not applicable or No Caregiver" to NA. The only variable that contained this response was no_talk51. This response was given 3 times.

We will also recode "Don’t Know" to NA.

```{r}
merged_screening_recode <- merged %>% 
  map_at(
    .x  = .,
    .at = select(merged, unusual_odor36:adls61) %>% names(),
    .f  = fct_recode, NULL = "Not applicable or No Caregiver"
  ) %>% 
  map_at(
    .x  = .,
    .at = select(merged, unusual_odor36:adls61) %>% names(),
    .f  = fct_recode, NULL = "Don’t Know"
  ) %>% 
  as_tibble()

about_data(merged_screening_recode) # 67 observations and 58 variables
```


[top](#top)

&nbsp;










-------------------------------------------------------------------------------

# Create a deidentified version of the merged data {#deidentify

-------------------------------------------------------------------------------

```{r}
merged_screening_recode_deidentified <- merged_screening_recode %>% 
  select(pair, age, unusual_odor36:compliance_match, time_diff:perp, disposition:any_valid)

about_data(merged_screening_recode_deidentified) # 67 observations and 35 variables
```

[top](#top)

&nbsp;










-------------------------------------------------------------------------------

# Save preprocessed data {#save}

-------------------------------------------------------------------------------

* Merged data with "Don't Know" and "Not applicable or No Caregiver" recoded to NA

```{r}
feather::write_feather(
  merged_screening_recode, 
  path = "/Users/bradcannell/Desktop/merged_screening_recode.feather"
)
```

* Merged data with "Don't Know" and "Not applicable or No Caregiver" recoded to NA and person-level identifiers removed from the data

    - feather version for me
    
    - CSV version for upload to [NACJD](https://www.icpsr.umich.edu/icpsrweb/content/NACJD/index.html)

```{r}
feather::write_feather(
  merged_screening_recode_deidentified,
  "../data/merged_screening_recode_deidentified.feather"
)

write_csv(
  merged_screening_recode_deidentified,
  "../data/merged_screening_recode_deidentified.csv"
)
```

[top](#top)

&nbsp;


```{r session_info, echo=FALSE}
sessionInfo()
```
