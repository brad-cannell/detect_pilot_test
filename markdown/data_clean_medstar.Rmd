---
title: "Data Clean MedStar Data"
date: "Created: 2016-09-09 <br> Updated: `r Sys.Date()`"
output: html_notebook
---

# Overview

In this file, we do general preprocessing of the raw MedStar data.

Specifically:

1. **DETECT_DATA_PIVOT.xlsx** - Data from MedStar that contains all uses of the DETECT screening tool.   

2. **DETECT-Patient-Data_2017-07-19_144931** - Data from MedStar that includes demographic and health information for all patients who where age >= 65 and treated during the pilot period.

# Table of contents

1. [Import and clean DETECT screening data](#detect-data)     
2. [Import and clean demographics and health data](#demographic-data)   
3. [Merge the screening data with the demographics and health data](#merge)    

```{r load_packages, message=FALSE}
library(tidyverse)
library(feather)
library(readxl)
library(stringr)
library(lubridate)
library(bfuncs)
```










-------------------------------------------------------------------------------

# Import and clean DETECT response data {#detect-data}

-------------------------------------------------------------------------------

```{r}
col_info <- c( 
  # "col_name",             "col_type"
  "response_num",           "text",
  "response_date",          "date",
  "aps_report_num",         "text",
  "full_name",              "text",
  "address",                "text",
  "city",                   "text",
  "state",                  "text",
  "zip",                    "text",
  "dob",                    "date",
  "age",                    "numeric",
  "unusual_odor36",         "text",
  "no_utils37",             "text",
  "hoarding38",             "text",
  "safe_env39",             "text",
  "alc_containers40",       "text",
  "cg_lack_know41",         "text",
  "cg_unengaged42",         "text",
  "cg_frustrated43",        "text",
  "cg_overwhelmed44",       "text",
  "cg_too_conerned45",      "text",
  "cg_deceptive46",         "text",
  "cg_bad_info47",          "text",
  "cg_alcdrugs48",          "text",
  "cg_dependent49",         "text",
  "socsup50",               "text",
  "no_talk51",              "text",
  "isolated52",             "text",
  "suspicious_injuries53",  "text",
  "old_injuries54",         "text",
  "alcdrugs55",             "text",
  "emo_distress56",         "text",
  "poor_hygiene57",         "text",
  "clothing58",             "text",
  "taking_meds59",          "text",
  "saving_meds60",          "text",
  "adls61",                 "text")

# Import data
medstar_detect <- read_excel(
  path = "/Users/bradcannell/Desktop/DETECT_DATA_PIVOT.xlsx",
  col_names = col_info[seq(1, length(col_info), 2)],
  col_types = col_info[seq(2, length(col_info), 2)],
  skip = 1)
rm(col_info)

about_data(medstar_detect) # 1,248 observations and 36 variables in the data
```


## Check for duplicate rows

First, check for entire duplicate rows

```{r}
# medstar_detect %>% filter(duplicated(.) | duplicated(., fromLast = TRUE)) # 2 rows
```

151003... Appears to have a duplicate row. Will drop.

```{r}
medstar_detect <- medstar_detect %>% filter(!duplicated(.))
```

Next, check for duplicate response numbers

```{r}
# medstar_detect %>%
  # filter(duplicated(response_num) | duplicated(response_num, fromLast = TRUE)) # 4 rows
```

151011... Includes information about two people. A man and a woman with the same last name. Both over age 65. Keep both rows because they are not duplicates of each other. They are two separate screenings that occurred at a single 911 response.

151024... Includes information about two people. A man and a woman with the same last name. Both over age 65. Keep both rows because they are not duplicates of each other. They are two separate screenings that occurred at a single 911 response.

```{r}
about_data(medstar_detect) # "1,247 observations and 36 variables"
```


## Separate name, address, and date of birth into multiple fields

```{r}
medstar_detect <- medstar_detect %>%
  mutate(
    first_name = str_extract(full_name, "^\\S*"),
    last_name = str_extract(full_name, "\\S*$"),
    birth_mnth = month(dob),
    birth_day  = day(dob),
    birth_year = year(dob),
    address_num = str_extract(address, "^\\d{1,5}"),
    address_street = str_trim(str_replace(address, "^\\d{1,5}", "")))
```


## Set all "NULL" values to NA   

```{r}
medstar_detect <- medstar_detect %>%
  # Null to NA
  map_if(.p = is.character, 
         .f = function(x) {
           x[x == "NULL"] <- NA 
           return(x)}) %>%
  as_tibble()
```


## Coerce selected character vectors (screening questions) to factors

```{r}
medstar_detect <- medstar_detect %>%
  map_at(
    .at = c(11:36),  # Screening questions
    .f = factor) %>%
  as_tibble
```


## Check response id's

Check to see if all the response id's from the MedStar compliance data exist in the current data.   

```{r}
# These response id's are from the data sent to me by MedStar compliance
# load("/Users/bradcannell/Desktop/response_ids.RData")

# Convert response_ids and medstar$response_num to atomic vectors
# ri <- unlist(response_ids)
# rn <- unlist(medstar_detect$response_num)

# Check for rows that appear in ri, but not rn
# no_match <- dplyr::setdiff(ri, rn)
# length(no_match)

# Save the 9 remaining id's
# match_ids <- dplyr::intersect(ri, rn)
# save(match_ids, file = "/Users/bradcannell/Desktop/match_ids.RData")

#clean up
# rm(response_ids, match_ids, no_match, ri, rn)
```

There are 7 responses id's in the MedStar compliance data that don't appear in the MedStar DETECT screening items data. I have an email from MedStar from 2016-10-10 outlining the discrepancy. One response id had all nulls for the DETECT screening items. One response id could not be found in the query. The rest were ineligible for the DETECT screening tool because of age.

At this point, there should be 9 response id's from the compliance data that have a match in the DETECT screening tool data.


## Add a dataset identifier tag

Adding a variable that will allow me to tell which rows had a DETECT screening tool use (even if all NA) after I merge this data with the demographics data below.

```{r}
medstar_detect$detect_data <- 1
```


## Count rows, unique responses, and unique people

```{r}
medstar_detect %>% 
  mutate(person = paste(full_name, dob)) %>% 
  group_by(response_num, full_name) %>% 
  mutate(response_names = paste(response_num, full_name)) %>%  
  ungroup() %>% 
  summarise(
    `Total Rows` = n() %>% format(big.mark = ","),
    `Unique 911 Responses` = unique(response_num) %>% length() %>% format(big.mark = ","),
    `Unique Response And Name` = unique(response_names) %>% length() %>% format(big.mark = ","),
    `Unique People` = unique(person) %>% length() %>% format(big.mark = ",")
  )
```

So, the MedStar detect screening data contains 1,247 total rows of data that correspond to 1,245 911 responses, 1,247 unique response/name combinations, and 1,141 unique people (assuming first name, last name, and age uniquely identifies people in this data).


## Remove identifiers and save

```{r}
medstar_detect_nid <- select(medstar_detect,
  age:adls61, detect_data
)

write_feather(medstar_detect_nid, "../data/medstar_detect_nid.feather")
```

```{r echo=FALSE}
# Save copy with identifiers
# Encrypt
# Securely store
write_feather(medstar_detect, "/Users/bradcannell/Desktop/medstar_detect.feather")
```










-------------------------------------------------------------------------------

# Import MedStar data containing the patient demographic and health information {#demographic-data}

-------------------------------------------------------------------------------

[top](#top)

```{r}
col_info <- c( 
  # "col_name",           "col_type"
  "date_entered",         "date",
  "incident_call_number", "text",
  "incident_pcr_number",  "text",
  "first_name",           "text",
  "last_name",            "text",
  "age",                  "numeric",
  "gender",               "text",
  "race",                 "text",
  "chief_complaint",      "text",
  "primary_impression",   "text",
  "primary_symptom",      "text",
  "other_symptom",        "text",
  "drug_use",             "text",
  "crew_member_id",       "text",
  "medical_surgery_hist", "text",
  "current_meds",         "text")

# Import data
medstar_demo <- read_excel(
  path = "/Users/bradcannell/Desktop/DETECT-Patient-Data_2017-07-19_144931.xlsx",
  col_names = col_info[seq(1, length(col_info), 2)],
  col_types = col_info[seq(2, length(col_info), 2)],
  skip = 1)
rm(col_info)

about_data(medstar_demo) # 99,724 observations and 16 variables
```


## Grab just the first part of two-part first names

```{r}
medstar_demo <- medstar_demo %>% mutate(first_name = str_extract(first_name, "^\\S*"))
```


## Check for duplicate rows

First, check for rows that are entirely duplicated

```{r}
sum(duplicated(medstar_demo)) # 413 rows that are duplicates across all variables
```

```{r}
sum(duplicated(medstar_demo) | duplicated(medstar_demo, fromLast = TRUE))
```

Not 426 because some combinations of values are duplicated in more than one row. For example:

```{r}
# example <- tibble(
#   id = c(1, 1, 2, 2, 2),
#   x1 = c(1, 1, 1, 1, 1)
# )
# 
# example %>%
#   mutate(
#     dup1 = duplicated(.),
#     dup2 = duplicated(.) | duplicated(., fromLast = TRUE)
#   ) %>% 
#   summarise(sum(dup1), sum(dup2)) # 5, not 6
```

Print out and check duplicate rows

```{r}
# dup_check <- medstar_demo
# # which(duplicated(dup_check) | duplicated(dup_check, fromLast = TRUE))
# dup_check$dup[duplicated(dup_check) | duplicated(dup_check, fromLast = TRUE)] <- 1
# dup_check %>% filter(dup == 1) %>% arrange(incident_call_number, crew_member_id, medical_surgery_hist, current_meds)
# rm(dup_check)
```

I manually inspected the duplicate rows. They appear to be genuine duplicates. Below I will drop the duplicate rows.

```{r}
medstar_demo <- distinct(medstar_demo)
about_data(medstar_demo) # 99,311 observations and 16 variables
```


## Check for incident call numbers that correspond to more than one person

```{r}
# Grab incident numbers where grouping by incident call number doesn't match grouping by incident call number and name.
# no_match <- medstar_demo %>%
#   group_by(incident_call_number) %>%
#   mutate(incident_row = row_number()) %>%
#   group_by(incident_call_number, first_name) %>%
#   mutate(incident_name_row = row_number()) %>%
#   filter(incident_row != incident_name_row) %>%
#   pull(incident_call_number) %>%  # 20 rows
#   unique() # 3 unique incidents

# Manually review these records
# medstar_demo %>%
#   filter(incident_call_number %in% no_match) %>%
#   arrange(incident_call_number, first_name) %>% 
#   # To make it easier, just keep one row per incident / name
#   group_by(incident_call_number, first_name) %>% 
#   mutate(row = row_number()) %>% 
#   filter(row == 1) # 6 rows
```

There can be more than one person per incident.

150927... Includes information about two people. A man and a woman with the same last name. Both over age 65.

151011... (also medstar_detect) Includes information about two people. A man and a woman with the same last name. Both over age 65.

151024... (also medstar_detect) Includes information about two people. A man and a woman with the same last name. Both over age 65.

```{r}
medstar_demo %>% 
  mutate(person = paste(first_name, last_name, age, sep = "_")) %>% 
  group_by(incident_call_number, first_name) %>% 
  mutate(incident_names = paste(incident_call_number, first_name, sep = "_")) %>% 
  ungroup() %>% 
  summarise(
    `Total Rows` = n() %>% format(big.mark = ","),
    `Unique Incidents` = unique(incident_call_number) %>% length() %>% format(big.mark = ","),
    `Unique PCR` = unique(incident_pcr_number) %>% length() %>% format(big.mark = ","),
    `Unique Incident And Name` = unique(incident_names) %>% length() %>% format(big.mark = ","),
    `Unique People` = unique(person) %>% length() %>% format(big.mark = ",")
  )
```

So, the MedStar demographics and health data contains 99,311 total rows of data that correspond to 2,011 911 responses, 2,018 PCR numbers, 2,014 unique response/name combinations, and 1,776 unique people (assuming first name, last name, and age uniquely identifies people in this data).

Spoke with MedStar on 2017-07-27. There are two reasons for multiple PCR numbers for a given incident number.

First, as described in the cases above, if there is more than one person treated at a given incident, they each get a unique PCR number.

Second, it could be an error caused by the chart being reopened to add more data. That appears to have happened some in our data. 

When thinking about linking information in this data with screening information, the combination of incident call number and first name will be our unique identifier of interest.


## Coerce selected character vectors to factors

```{r}
medstar_demo <- medstar_demo %>%
  map_at(
    .at = c("gender", "race", "chief_complaint", "primary_impression", "primary_symptom", "other_symptom",
            "drug_use", "crew_member_id", "medical_surgery_hist", "current_meds"),
    .f = factor) %>%
  as_tibble
```










-------------------------------------------------------------------------------

# Merge the screening data with the demographics and health data {#merge}

-------------------------------------------------------------------------------

The MedStar DETECT data has 1,247 observations for 1,245 unique responses / people.

The MedStar demographics and health data has 99,311 observations for 2,014 unique responses / people.

Each DETECT screening should have a match in the demographics data (incident_call_number <-> response_num).

```{r}
# screening <- medstar_detect %>% arrange(response_num) %>% pull(response_num) %>% unique()
# demographics <- medstar_demo %>% arrange(incident_call_number) %>% pull(incident_call_number) %>% unique()
# setdiff(screening, demographics) # Elements in that appear in screening, but not demographics.
# rm(screening, demographics)
```

Every DETECT screen has a match in the demographics and health file.

Also remember that in both data sets there are a few instances of multiple people treated at a single incident / response. Therefore, joining only by incident number will join every row in the demographics data with a matching row in screening data, _even when person in that row is different_. 

Additionally, it also appears as though there are cases where there is a matching incident number in both data sets; however, the first name doesn’t match across data sets because of a two-name type name. For example, something like Mary Sue in the DETECT screening data and Mary in the demographics data.

See the example below.

```{r}
# # Example
# # df1 <- tibble(
# #   id = c(1, 1, 1, 1, 2),
# #   first_name = c("Sally Ann", "John", "Sally Ann", "John", "Alex"), # Sally and John have the same id
# #   last_name = c(rep("Smith", 4), "Adams"),
# #   race = c(1, 1, 1, 1, 3),
# #   med = c("a", "b", "c", "d", NA)
# # )
# 
# # df2 <- tibble(
# #   pid = c(1, 1),
# #   first_name = c("Sally", "John"),
# #   last_name = rep("Smith", 2),
# #   screen = c(0, 1)
# # )
# 
# # Compare - Check for discrepencies
# # df3 <- df1 %>% full_join(df2, by = c("id" = "pid"))
# # df3
# 
# # df3 <- df1 %>% full_join(df2, by = c("id" = "pid", "first_name"))
# # df3
# 
# # df3 %>%
# #   select(id, first_name) %>%
# #   distinct() %>%                               # Reduces to unique id/name combinations
# #   mutate(combo = row_number()) %>%             # Number each row
# #   spread(combo, first_name) %>%                # Creates a column for each name
# #   mutate(n_names = rowSums(!is.na(.)) - 1) %>% # Count non-missing values in row, minus the id
# #   filter(n_names > 1) %>%                      # Keep rows with more than 1 name
# #   select_if(~sum(!is.na(.)) > 0) %>%           # Drop all of the empty columns
# #   gather(col_num, names, -id, -n_names) %>%    # Change to long format
# #   filter(!is.na(names)) %>%                    # Drop all the rows with a value of NA for names
# #   arrange(id) %>%
# #   select(id, names) %>%
# #   group_by(id) %>%
# #   mutate(
# #     row = row_number(),
# #     row = paste0("First Name ", row)
# #   ) %>%
# #   spread(row, names)
# 
# # In the end, I should have two complete rows for Sally (one for med a and one for med c), two complete rows for John (one for med b and one for med d), and One row for Alex that is missing med and screen.
# # df1 <- df1 %>% mutate(first_name = str_extract(first_name, "^\\S*"))
# # df3 <- df1 %>% left_join(df2, by = c("id" = "pid", "first_name"))
# # df3
# 
# # rm(df1, df2, df3)
```


## Merge the data sets

```{r}
check_names <- medstar_demo %>% 
  left_join(medstar_detect, by = c("incident_call_number" = "response_num", "first_name"))
about_data(check_names) # 99,311 observations and 58 variables
```

**Are all 1,247 screening rows still in the data?**

```{r}
check_names %>% 
  group_by(incident_call_number, first_name) %>% # There are responses with a screening for two different people
  mutate(incident_name_id = row_number()) %>% # 1 to r for each combination of incident number and first name
  ungroup() %>% 
  filter(incident_name_id == 1) %>% # 1 row per incident number and name
  group_by(detect_data) %>% 
  summarise(n())
```


## How many incident numbers in each data set match, but do not have matching first names?

```{r}
# check_names %>%
#   select(incident_call_number, first_name) %>%
#   distinct() %>%                                              # Reduces to unique id/name combinations
#   mutate(combo = row_number()) %>%                            # Number each row
#   spread(combo, first_name) %>%                               # Creates a column for each name
#   mutate(n_names = rowSums(!is.na(.)) - 1) %>%                # Count non-missing values in row, minus the id
#   filter(n_names > 1) %>%                                     # Keep rows with more than 1 name
#   select_if(~sum(!is.na(.)) > 0) %>%                          # Drop all of the empty columns
#   gather(col_num, names, -incident_call_number, -n_names) %>% # Change to long format
#   filter(!is.na(names)) %>%                                   # Drop all the rows with a value of NA for names
#   arrange(incident_call_number) %>%
#   select(incident_call_number, names) %>%
#   group_by(incident_call_number) %>%
#   mutate(
#     row = row_number(),
#     row = paste0("First Name ", row)
#   ) %>%
#   spread(row, names)
```

There are 3 total incident numbers that are associated with two first names. They are all completely different first names. They belong to the instances when a male and female were treated at the same response. There is more information about these cases above.

Because we joined on id AND first name, there shouldn't be any instances of mixing information from "John" and "Sally" between rows. See example above.

Also did a manual double check of the data, and everything looks good.


## How many incident numbers in each data set match, but do not have matching last names?

```{r}
# check_names %>%
#   select(incident_call_number, last_name.x, last_name.y) %>%
#   filter(last_name.x != last_name.y) %>%                       # Find non-matching pairs
#   group_by(incident_call_number, last_name.x, last_name.y) %>% 
#   mutate(row = row_number()) %>% 
#   filter(row == 1)                                             # Keep one example of each non-matching pair
```

There appears to be one practice chart in the data. It needs to be removed. 

```{r}
check_names <- check_names %>% filter(!last_name.x == "Practice chart")
about_data(check_names) # "99,309 observations and 58 variables"
```

The rest of the non-matching pairs are because of two-part last names in x and a single last name in y. For example, St Mary in x and just Mary in y. 

We can just drop last name x, and rename last name y to last name.

```{r}
check_names <- check_names %>% mutate(last_name.x = NULL)
check_names <- check_names %>% rename(last_name = last_name.y)
check_names <- check_names %>% mutate(row = NULL)
about_data(check_names) # 99,309 observations and 57 variables
```

The demographics and health data is now linked to the DETECT screening data. There are some instances when more than one person was screened at a given incident. However, each incident number / first name should be linked to a unique screening - if one exists.


## Rename the data set

```{r}
medstar_detect_demo <- check_names
rm(check_names)
about_data(medstar_detect_demo) # 99,309 observations and 57 variables
```


## Drop the redundant age variable.

```{r}
medstar_detect_demo$age.y <- NULL
medstar_detect_demo <- rename(medstar_detect_demo, age = age.x)
```


## Remove identifiers from combined data and save

```{r}
medstar_detect_demo_nid <- select(medstar_detect_demo, 
  age:drug_use, medical_surgery_hist:current_meds, unusual_odor36:adls61, detect_data
)

write_feather(medstar_detect_demo_nid, "../data/medstar_detect_demo_nid.feather")
```

```{r echo=FALSE}
# Save copy with identifiers
# Encrypt
# Securely store
write_feather(medstar_detect_demo, "/Users/bradcannell/Desktop/medstar_detect_demo.feather")
```

```{r echo=FALSE, results='hide'}
# Clean up
rm(medstar_demo, medstar_detect, medstar_detect_demo, medstar_detect_demo_nid, medstar_detect_nid)
```

---

```{r echo=FALSE}
sessionInfo()
```
