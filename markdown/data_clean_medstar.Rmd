---
title: "Data Clean MedStar Data"
date: "Created: 2016-09-09 <br> Updated: `r Sys.Date()`"
output: 
  html_notebook:
    css: custom-css.css
---

# Overview

In this file, we import the raw data files received from MedStar and do some basic data checks.

Specifically we import the following two files:

1. **DETECT_DATA_PIVOT.xlsx** - Data from MedStar that contains all uses of the DETECT screening tool.   

2. **DETECT-Patient-Data_2017-07-19_144931.xlsx** - Data from MedStar that includes demographic and health information for all patients who where age >= 65 and treated during the pilot period.


# Key variable definitions 

It's important to understand the meaning of patient identification variables in the data, and the relationship between patient identification variables across both datasets. The following diagram shows how people are identified in the MedStar data:

![](../images/medstar_detect_identifiers.png)

However, after manually checking the datasets we found that the terms "Incident" and "Response" are used inconsistently between files. 

* In **DETECT_DATA_PIVOT.xlsx**:

    - **Response number** is unique to the incident/respnse (#2 in the diagram). In cases where there was more than one person screened at an incident/response, the response number is not unique to the person/screening (#3 and #4 in the diagram). This number matches response number in DETECT-Patient-Data_2017-07-19_144931.xlsx.
    
    - **Response date** is the date that MedStar ran the 911 call and filled out the DETECT screening tool.
    
* In **DETECT-Patient-Data_2017-07-19_144931.xlsx**:

    - **Date entered** is the date that MedStar ran the 911 call and filled out the DETECT screening tool.
    
    - **Incident call number** is unique to the incident/respnse (#2 in the diagram). In cases where there was more than one person screened at an incident/response, the response number is not unique to the person/screening (#3 and #4 in the diagram). This number matches response number in DETECT_DATA_PIVOT.xlsx.
    
    - **Incident PCR number** is unique to the person/DETECT screening at a given incident/response. Below, we add this number to DETECT_DATA_PIVOT.xlsx. NOTE: No two people should have the same incident PCR number; however, a single person may have multiple incident PCR numbers if they were treated by MedStar on multiple occasions.
    
In order to be consistent and reduce confusion, after importing the data below, we will use the terminology from DETECT-Patient-Data_2017-07-19_144931.xlsx.


# Table of contents

1. [Import and clean DETECT screening data](#detect-data)     
2. [Import and clean demographics and health data](#demographic-data)    
3. [# Add incident PCR number to MedStar DETECT data](#add-pcr)     
4. [Merge the screening data with the demographics and health data](#merge)    
5. [Save data for merge with APS data](#save)    


```{r setup, include=FALSE}
knitr::opts_chunk$set(comment = NA)
Sys.setenv(TZ = "US/Central")
```

```{r load_packages, message=FALSE}
library(tidyverse)
library(feather)
library(readxl)
library(stringr)
library(lubridate)
library(bfuncs)
```

&nbsp;










-------------------------------------------------------------------------------

# Import and clean DETECT response data {#detect-data}

-------------------------------------------------------------------------------

```{r}
col_info <- c( 
  # "col_name",             "col_type"
  "response_num",           "text",
  "response_date",          "date",
  "aps_report_num",         "text",
  "full_name",              "text",
  "address",                "text",
  "city",                   "text",
  "state",                  "text",
  "zip",                    "text",
  "dob",                    "date",
  "age",                    "numeric",
  "unusual_odor36",         "text",
  "no_utils37",             "text",
  "hoarding38",             "text",
  "safe_env39",             "text",
  "alc_containers40",       "text",
  "cg_lack_know41",         "text",
  "cg_unengaged42",         "text",
  "cg_frustrated43",        "text",
  "cg_overwhelmed44",       "text",
  "cg_too_conerned45",      "text",
  "cg_deceptive46",         "text",
  "cg_bad_info47",          "text",
  "cg_alcdrugs48",          "text",
  "cg_dependent49",         "text",
  "socsup50",               "text",
  "no_talk51",              "text",
  "isolated52",             "text",
  "suspicious_injuries53",  "text",
  "old_injuries54",         "text",
  "alcdrugs55",             "text",
  "emo_distress56",         "text",
  "poor_hygiene57",         "text",
  "clothing58",             "text",
  "taking_meds59",          "text",
  "saving_meds60",          "text",
  "adls61",                 "text")

# Import data
medstar_detect <- read_excel(
  path = "/Users/bradcannell/Desktop/DETECT_DATA_PIVOT.xlsx",
  col_names = col_info[seq(1, length(col_info), 2)],
  col_types = col_info[seq(2, length(col_info), 2)],
  skip = 1)
rm(col_info)

about_data(medstar_detect) # 1,248 observations and 36 variables in the data
```


## Check for duplicate rows

First, check for entire duplicate rows

```{r}
medstar_detect %>% 
  group_by_all() %>% 
  filter(n() > 1) %>% 
  count() %>% 
  ungroup() %>% 
  select(n)
```

151003... Appears to have a duplicate row. Will drop.

```{r}
medstar_detect <- medstar_detect %>% 
  group_by_all() %>% 
  mutate(
    count = row_number(), # Counts rows by group
    dup   = count > 1     # TRUE if there is more than one row per group
  ) %>% 
  filter(!dup) %>% 
  select(-count, -dup)

about_data(medstar_detect) # 1,247 observations and 36 variables
```

## Check for duplicate response numbers

```{r}
medstar_detect %>% 
  group_by(response_num) %>% 
  filter(n() > 1) %>% 
  count() %>% 
  ungroup() %>% 
  select(n) # 2 sets of duplicates (4 rows)
```

151011... Includes information about two people. A man and a woman with the same last name. Both over age 65. Keep both rows because they are not duplicates of each other. They are two separate screenings that occurred at a single 911 response.

151024... Includes information about two people. A man and a woman with the same last name. Both over age 65. Keep both rows because they are not duplicates of each other. They are two separate screenings that occurred at a single 911 response.

```{r}
about_data(medstar_detect) # "1,247 observations and 36 variables"
```


## Separate name, address, and date of birth into multiple fields

```{r}
medstar_detect <- medstar_detect %>%
  mutate(
    first_name = str_extract(full_name, "^\\S*"),
    last_name = str_extract(full_name, "\\S*$"),
    birth_mnth = month(dob),
    birth_day  = day(dob),
    birth_year = year(dob),
    address_num = str_extract(address, "^\\d{1,5}"),
    address_street = str_trim(str_replace(address, "^\\d{1,5}", "")))
```


## Set all "NULL" values to NA   

```{r}
medstar_detect <- medstar_detect %>%
  # Null to NA
  map_if(.p = is.character, 
         .f = function(x) {
           x[x == "NULL"] <- NA 
           return(x)}) %>%
  as_tibble()
```


## Coerce selected character vectors (screening questions) to factors

```{r}
medstar_detect <- medstar_detect %>%
  map_at(
    .at = c(11:36),  # Screening questions
    .f = factor) %>%
  as_tibble
```


## Check response id's

Check to see if all the response id's from the MedStar compliance data exist in the current data.   

```{r}
response_ids <- feather::read_feather("/Users/bradcannell/Desktop/response_ids.feather")
```

```{r eval=FALSE}
response_ids %>% 
  anti_join(medstar_detect, by = "response_num") %>%  # 6 response numbers
  unique()
```


There are 6 responses id's in the MedStar compliance data that don't appear in the MedStar DETECT screening items data (results hidden to protect participant privacy). I have an email from MedStar from 2016-10-10 outlining the discrepancy. One response id had all nulls for the DETECT screening items. One response id could not be found in the query. The rest were ineligible for the DETECT screening tool because of age.

At this point, there should be 8 response id's from the compliance data that have a match in the DETECT screening tool data (results hidden to protect participant privacy).

```{r eval=FALSE}
response_ids %>% 
  semi_join(medstar_detect, by = "response_num") %>%  # 8 response numbers
  unique()
```


## Add a dataset identifier tag

Adding a variable that will allow me to tell which rows had a DETECT screening tool use (even if all NA) after I merge this data with the demographics data below.

```{r}
medstar_detect$detect_data <- 1
```


## Count rows, unique responses, and unique people

```{r}
medstar_detect %>% 
  mutate(person = paste(full_name, dob)) %>% 
  group_by(response_num, full_name) %>% 
  mutate(response_names = paste(response_num, full_name)) %>%  
  ungroup() %>% 
  summarise(
    `Total Rows` = n() %>% format(big.mark = ","),
    `Unique 911 Responses` = unique(response_num) %>% length() %>% format(big.mark = ","),
    `Unique Response And Name` = unique(response_names) %>% length() %>% format(big.mark = ","),
    `Unique People` = unique(person) %>% length() %>% format(big.mark = ",")
  )
```

So, the MedStar detect screening data contains 1,247 total rows of data that correspond to 1,245 911 responses, 1,247 unique response/name combinations, and 1,141 unique people (assuming first name, last name, and age uniquely identifies people in this data).


## Rename response number

In order to be consistent and reduce confusion, we will use the terminology from DETECT-Patient-Data_2017-07-19_144931.xlsx.

```{r}
medstar_detect <- medstar_detect %>% rename(incident_call_number = response_num)
about_data(medstar_detect) # 1,247 observations and 44 variables
```

[top](#top)

&nbsp;










-------------------------------------------------------------------------------

# Import MedStar data containing the patient demographic and health information {#demographic-data}

-------------------------------------------------------------------------------

```{r}
col_info <- c( 
  # "col_name",           "col_type"
  "date_entered",         "date",
  "incident_call_number", "text",
  "incident_pcr_number",  "text",
  "first_name",           "text",
  "last_name",            "text",
  "age",                  "numeric",
  "gender",               "text",
  "race",                 "text",
  "chief_complaint",      "text",
  "primary_impression",   "text",
  "primary_symptom",      "text",
  "other_symptom",        "text",
  "drug_use",             "text",
  "crew_member_id",       "text",
  "medical_surgery_hist", "text",
  "current_meds",         "text")

# Import data
medstar_demo <- read_excel(
  path = "/Users/bradcannell/Desktop/DETECT-Patient-Data_2017-07-19_144931.xlsx",
  col_names = col_info[seq(1, length(col_info), 2)],
  col_types = col_info[seq(2, length(col_info), 2)],
  skip = 1)
rm(col_info)

about_data(medstar_demo) # 99,724 observations and 16 variables
```


## Grab just the first part of two-part first names

```{r}
medstar_demo <- medstar_demo %>% 
  mutate(first_name = str_extract(first_name, "^\\S*"))
```


## Check for duplicate rows

First, check for rows that are entirely duplicated

```{r}
order_all_cols <- names(medstar_demo) %>% rlang::syms()
medstar_demo %>% 
  arrange(!!!order_all_cols) %>% 
  group_by_all() %>% 
  filter(n() > 1) %>% 
  count() %>% 
  ungroup() %>% 
  select(n) # 387 groups of duplicates
```

I manually inspected the duplicate rows. They appear to be genuine duplicates. Below I will drop the duplicate rows.

```{r}
rm(order_all_cols)
```

```{r}
medstar_demo <- medstar_demo %>% 
  group_by_all() %>% 
  mutate(
    count = row_number(), # Counts rows by group
    dup   = count > 1     # TRUE if there is more than one row per group
  ) %>% 
  ungroup() %>% 
  filter(!dup) %>% 
  select(-count, -dup)

about_data(medstar_demo) # 99,311 observations and 16 variables
```


## Check for incident PCR numbers that correspond to more than one person

NOTE: No two people should have the same incident PCR number; however, a single person may have multiple incident PCR numbers if they were treated by MedStar on multiple occasions.

NOTE: There are multiple rows in this data for each person. Those rows that are complete duplicates were already dropped above. Because our purpose is just to see if there are any instances were a incident PCR number corresponds to more than one name, we are just going to keep one row per combination of incident PCR number and first name.

```{r}
medstar_demo %>% 
  group_by(incident_pcr_number, first_name) %>% 
  mutate(count = row_number()) %>% 
  filter(count == 1) %>% # 2,018 rows
  ungroup() %>% 
  summarise(
    `Rows grouped by PCR and Name` = n(),
    `Unique PCR numbers` = unique(incident_pcr_number) %>% length()
  )
```

The number of rows when grouped by incident PCR number and name (2,019) is the same as the number of unique incident PCR numbers. Therefore, each incident PCR number is associated with a single person. Again, however, any given person my have multiple incident PCR numbers if they were treated by MedStar more than once.


## Count rows, unique responses, and unique people

```{r}
medstar_demo %>% 
  mutate(person = paste(first_name, last_name, age, sep = "_")) %>% 
  group_by(incident_call_number, first_name) %>% 
  mutate(incident_names = paste(incident_call_number, first_name, sep = "_")) %>% 
  ungroup() %>% 
  summarise(
    `Total Rows` = n() %>% format(big.mark = ","),
    `Unique Incidents` = unique(incident_call_number) %>% length() %>% format(big.mark = ","),
    `Unique PCR` = unique(incident_pcr_number) %>% length() %>% format(big.mark = ","),
    `Unique Incident And Name` = unique(incident_names) %>% length() %>% format(big.mark = ","),
    `Unique People` = unique(person) %>% length() %>% format(big.mark = ",")
  )
```

So, the MedStar demographics and health data contains 99,311 total rows of data that correspond to 2,011 911 responses, 2,018 incident PCR numbers, 2,014 unique response/name combinations, and 1,776 unique people (assuming first name, last name, and age uniquely identifies people in this data).


## Why does "Unique PCR" and "Unique Incident And Name" Differ?

Theoretically, these should be the same. Below, we inspect the data to understand the discrepancy (results hidden to protect participant privacy).

```{r eval=FALSE}
medstar_demo %>% 
  
  # Count total rows for each PCR number
  group_by(incident_pcr_number) %>% 
  mutate(count_pcr = n()) %>% 
  
  # Count total rows for each combo of incident and name
  group_by(incident_call_number, first_name) %>% 
  mutate(incident_name_count = n()) %>% 
  
  # Where do they differ?
  ungroup() %>% 
  filter(count_pcr != incident_name_count) %>% 
  
  # PCR number changes more frequently (2,108) than incident/name combos (2,104)
  # Keep one row per PCR number
  group_by(incident_pcr_number) %>% 
  filter(row_number() == 1)
```


There are 4 groups of incident call numbers that have multiple incident PCR numbers for the same person. For example:

incident_call_number | incident_pcr_number | first_name | last_name
-------------------- | ------------------- | ---------- | ---------
150917001            | 15000001            | John       | Smith
150917001            | 15000002            | John       | Smith

We spoke with MedStar on 2017-07-27. There are two reasons for multiple PCR numbers for a given incident number:

1. If there is more than one person treated at a given incident, they each get a unique PCR number, which does not apply to the cases above.

2. It could be an error caused by the chart being reopened to add more data. That appears to have happened some in our data. The dates, times, etc. are all identical. 

Therefore, for each group, we are going to keep only one incident PCR number. We will arbitrarily retain the lowest incident PCR number.


## Condense incident PCR numbers within combinations of incident call number and name

```{r}
medstar_demo <- medstar_demo %>% 
  group_by(incident_call_number, first_name) %>% 
  mutate(incident_pcr_number = min(incident_pcr_number)) %>% 
  ungroup()
```


## Count rows, unique responses, and unique people

```{r}
medstar_demo %>% 
  mutate(person = paste(first_name, last_name, age, sep = "_")) %>% 
  group_by(incident_call_number, first_name) %>% 
  mutate(incident_names = paste(incident_call_number, first_name, sep = "_")) %>% 
  ungroup() %>% 
  summarise(
    `Total Rows` = n() %>% format(big.mark = ","),
    `Unique Incidents` = unique(incident_call_number) %>% length() %>% format(big.mark = ","),
    `Unique PCR` = unique(incident_pcr_number) %>% length() %>% format(big.mark = ","),
    `Unique Incident And Name` = unique(incident_names) %>% length() %>% format(big.mark = ","),
    `Unique People` = unique(person) %>% length() %>% format(big.mark = ",")
  )
```

And now the number of unique PCR numbers and unique combinations of incident call number and name are identical.


## Coerce selected character vectors to factors

```{r}
medstar_demo <- medstar_demo %>%
  map_at(
    .at = c("gender", "race", "chief_complaint", "primary_impression", "primary_symptom", "other_symptom",
            "drug_use", "crew_member_id", "medical_surgery_hist", "current_meds"),
    .f = factor) %>%
  as_tibble
```

[top](#top)

&nbsp;










-------------------------------------------------------------------------------

# Add incident PCR number to MedStar DETECT data {#add-pcr}

-------------------------------------------------------------------------------

* Incident PCR number does not currently exist in the DETECT data.

* There can be more than one person per incident call number in the DETECT data. That's the reason incident PCR numbers exist.

* Therefore, we will need to join incident PCR number to the DETECT data by incident call number and name.

```{r}
medstar_detect <- medstar_detect %>% 
  left_join(
    medstar_demo %>%
      select(incident_call_number, incident_pcr_number, first_name) %>% 
      group_by(incident_pcr_number) %>% 
      distinct(), # Only keep unique PCR numbers: 2,014
    by = c("incident_call_number", "first_name")
  ) %>% 
  select(response_date, incident_call_number, incident_pcr_number, everything())
```


## Count rows, unique responses, and unique people

```{r}
medstar_detect %>% 
  mutate(person = paste(first_name, last_name, age, sep = "_")) %>% 
  group_by(incident_call_number, first_name) %>% 
  mutate(incident_names = paste(incident_call_number, first_name, sep = "_")) %>% 
  ungroup() %>% 
  summarise(
    `Total Rows` = n() %>% format(big.mark = ","),
    `Unique Incidents` = unique(incident_call_number) %>% length() %>% format(big.mark = ","),
    `Unique PCR` = unique(incident_pcr_number) %>% length() %>% format(big.mark = ","),
    `Unique Incident And Name` = unique(incident_names) %>% length() %>% format(big.mark = ","),
    `Unique People` = unique(person) %>% length() %>% format(big.mark = ",")
  )
```

[top](#top)

&nbsp;










-------------------------------------------------------------------------------

# Merge the screening data with the demographics and health data {#merge}

-------------------------------------------------------------------------------

* The MedStar DETECT data has 1,247 unique DETECT screenings - 1 per PCR number

* The MedStar demographics and health data has 99,311 observations for 2,014 unique incident / person combinations - 1 per PCR number

* Each PCR number in the DETECT screening data should have a matching PCR number in the demographics data 


## Check to make sure PCR numbers match between datasets

```{r}
medstar_detect %>% anti_join(medstar_demo, by = "incident_pcr_number") # 0
```

Every DETECT screen has a match in the demographics and health file.


## Merge data

```{r}
medstar_detect_demo <- medstar_demo %>% 
  left_join(medstar_detect, by = "incident_pcr_number")
```

```{r}
about_data(medstar_detect_demo) # 99,311 observations and 60 variables
```


## Data checks

Count the number of differences that between variables that appear in both datasets.

The `na.rm = TRUE` is needed because not every eligible older adult that MedStar treated received the DETECT screening. Those that did not have `NA` for every variable that comes from the DETECT data.

```{r}
medstar_detect_demo %>% 
  summarise(
    `Different incident numbers` = sum(incident_call_number.x != incident_call_number.y, na.rm = TRUE),
    `Different first` = sum(first_name.x != first_name.y, na.rm = TRUE),
    `Different last` = sum(last_name.x != last_name.y, na.rm = TRUE),
    `Different age` = sum(age.x != age.y, na.rm = TRUE)
  )
```

## Keep on incident number variable and one first name variable only

```{r}
medstar_detect_demo <- medstar_detect_demo %>% 
  select(-incident_call_number.y, -first_name.y) %>% 
  rename(first_name = first_name.x, incident_call_number = incident_call_number.x)
```

```{r}
about_data(medstar_detect_demo) # 99,311 observations and 58 variables
```


## Different last names

(results hidden to protect participant privacy)

```{r eval=FALSE}
medstar_detect_demo %>% 
  filter(last_name.x != last_name.y) %>% 
  group_by(incident_pcr_number) %>% 
  filter(row_number() == 1) %>% 
  select(incident_pcr_number, starts_with("first_name"), starts_with("last_name"), everything())
```

* Incident PCR number 15....99 (2 rows) is a practice chart and should be dropped from the data.

* The other 4 appear to be true matches, where:

    - There was a slight mispelling
    
    - They had a two-name type name. For example, something like "St John"" in the demographics data and "John" in the DETECT data.
    
    
## Drop practice chart

```{r}
medstar_detect_demo <- medstar_detect_demo %>% 
  filter(last_name.x != "Practice chart")
```

```{r}
about_data(medstar_detect_demo) # 99,309 observations and 58 variables
```


## Different ages

(results hidden to protect participant privacy)

```{r eval=FALSE}
medstar_detect_demo %>% 
  filter(age.x != age.y) %>% 
  group_by(incident_pcr_number) %>% 
  filter(row_number() == 1) %>% 
  select(incident_pcr_number, age.x, age.y, everything())
```

Most of these differences appear to be off by rounding errors. Additionally, not every person in the data has a value for age.y. Therefore, we will just keep age.x


## Keep one age variable

```{r}
medstar_detect_demo <- medstar_detect_demo %>% 
  select(-age.y) %>% 
  rename(age = age.x)
```

```{r}
about_data(medstar_detect_demo) # 99,309 observations and 57 variables
```

The demographics and health data is now linked to the DETECT screening data. There are some instances when more than one person was screened at a given incident. However, each incident PCR number is linked to a unique screening - if one exists.










-------------------------------------------------------------------------------

# Save data for merge with APS data {#save}

-------------------------------------------------------------------------------

```{r}
write_feather(medstar_detect, "/Users/bradcannell/Desktop/medstar_detect.feather")
write_feather(medstar_demo, "/Users/bradcannell/Desktop/medstar_demo.feather")
write_feather(medstar_detect_demo, "/Users/bradcannell/Desktop/medstar_detect_demo.feather")
```

[top](#top)


```{r echo=FALSE}
sessionInfo()
```
